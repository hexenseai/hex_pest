{% extends "unfold/layouts/base_simple.html" %}
{% load i18n unfold %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    {% include "unfold/helpers/messages.html" %}

    <div class="mb-6 flex flex-wrap items-center gap-4">
        <a href="{% url 'admin:core_workrecord_change' work_record.pk %}" class="text-primary-600 hover:underline">
            ← İş kaydına dön
        </a>
        {% if istasyon_sayim_toplu_url %}
        <a href="{{ istasyon_sayim_toplu_url }}" class="text-primary-600 hover:underline">
            Toplu liste →
        </a>
        {% endif %}
        <h1 class="text-xl font-semibold">{{ title }}</h1>
    </div>

    {% if locked %}
    <div class="p-4 mb-6 rounded-lg bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200 border border-amber-200 dark:border-amber-800">
        Bitiş saati girildiği için sayım kilitlendi. Ekleneme veya değişiklik yapılamaz.
    </div>
    {% endif %}

    <div class="mb-6 p-4 rounded-lg bg-base-100 dark:bg-base-800 border border-base-200 dark:border-base-700">
        <p class="text-base-font-medium-light dark:text-base-font-medium-dark">
            {{ work_record.tarih }} — {{ work_record.personel.get_username }}{% if work_record.ekip %} ({{ work_record.ekip }}){% endif %}
            {% if work_record.baslama_saati %} {{ work_record.baslama_saati }}{% endif %}
            {% if work_record.bitis_saati %} – {{ work_record.bitis_saati }}{% endif %}
        </p>
    {% if summary_facility or summary_zone %}
        {% if summary_facility and selected_facility %}
        <p class="mb-1">
            <strong>Tesis ({{ selected_facility }}):</strong>
            Toplam {{ summary_facility.toplam }} istasyon, {{ summary_facility.girilen }} giriş yapıldı, <strong>{{ summary_facility.kalan }} kalan</strong>
        </p>
        {% endif %}
        {% if summary_zone %}
        <p>
            <strong>Bölge:</strong>
            Toplam {{ summary_zone.toplam }} istasyon, {{ summary_zone.girilen }} giriş yapıldı, <strong>{{ summary_zone.kalan }} kalan</strong>
        </p>
        {% endif %}
    {% endif %}
    </div>

    <section class="p-4 rounded-lg border border-base-200 dark:border-base-700 bg-base-50 dark:bg-base-800 mb-6">
        <h2 class="text-lg font-semibold mb-4">İstasyon sayım girişi</h2>
        <p class="text-sm text-base-font-muted-light dark:text-base-font-muted-dark mb-3">
            QR okutun veya benzersiz kodu yazın, ardından tüketim durumunu işaretleyin.
        </p>
        {% if not locked %}
        <div id="tek-giris-form" class="space-y-4 tek-giris-buyuk">
            <div class="w-full max-w-full">
                <label for="benzersiz_kod" class="block text-base font-medium mb-2">İstasyon Kodu</label>
                <div class="w-full">
                    <input type="text" id="benzersiz_kod" placeholder="MÜŞTERİ-TESİS-BÖLGE-İSTASYON"
                        class="w-full box-border text-xl px-5 py-4 rounded-xl border border-base-300 dark:border-base-600 bg-white dark:bg-base-900 dark:text-base-font-default-dark focus:outline-none focus:ring-2 focus:ring-primary-500"
                        autocomplete="off">
                    <div class="flex gap-3 mt-3 w-full">
                        <button type="button" id="qr-oku-btn" title="QR kod oku"
                            class="flex-1 min-w-0 py-5 rounded-xl bg-base-200 dark:bg-base-600 text-base-font-default-light dark:text-base-font-default-dark hover:bg-base-300 dark:hover:bg-base-500 font-bold text-lg focus:outline-none focus:ring-2 focus:ring-primary-400 shadow-md">
                            QR okut
                        </button>
                        <button type="button" id="lookup-btn"
                            class="flex-1 min-w-0 py-5 rounded-xl bg-primary-600 text-white hover:bg-primary-700 font-bold text-lg focus:outline-none focus:ring-2 focus:ring-primary-400 shadow-md">
                            BUL
                        </button>
                    </div>
                </div>
            </div>
            <div id="station-info" class="hidden p-4 rounded-xl bg-base-200 dark:bg-base-700 text-xl mb-4"></div>
            <form method="post" action="{{ istasyon_sayim_url }}{% if selected_facility %}?facility={{ selected_facility.pk }}{% if selected_zone_id %}&zone={{ selected_zone_id }}{% endif %}{% endif %}" id="sayim-save-form" class="hidden space-y-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="save">
                <input type="hidden" name="station_id" id="station_id" value="">
                <div>
                    <label for="not_alani" class="block text-base font-medium mb-2">Not (isteğe bağlı)</label>
                    <input type="text" id="not_alani" name="not_alani" maxlength="200"
                        class="w-full text-xl px-5 py-4 border rounded-xl dark:bg-base-900 dark:border-base-600 focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" name="tuketim_var" value="1"
                        class="flex-1 py-8 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-2xl shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
                        Tüketim var
                    </button>
                    <button type="submit" name="tuketim_var" value="0"
                        class="flex-1 py-8 rounded-xl bg-green-600 hover:bg-green-700 text-white font-bold text-2xl shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                        Tüketim yok
                    </button>
                </div>
            </form>
        </div>
        {% else %}
        <p class="text-base-font-muted-light dark:text-base-font-muted-dark">Sayım kilitli.</p>
        {% endif %}
    </section>

    {% if selected_facility %}
    <div class="space-y-4">
        <details class="rounded-lg border border-base-200 dark:border-base-700 bg-base-50 dark:bg-base-800 overflow-hidden" {% if bakilmis_stations %}open{% endif %}>
            <summary class="px-4 py-3 cursor-pointer font-semibold text-base-font-default-light dark:text-base-font-default-dark hover:bg-base-300 dark:hover:bg-base-700">
                Bakılmış istasyonlar ({{ bakilmis_stations|length }})
            </summary>
            <div class="border-t border-base-200 dark:border-base-700">
                {% if bakilmis_stations %}
                <div class="overflow-auto max-h-48">
                <table class="w-full text-sm border-collapse">
                    <thead>
                        <tr class="border-b border-base-200 dark:border-base-600 bg-base-200 dark:bg-base-700">
                            <th class="text-left py-2 px-2">İstasyon</th>
                            <th class="text-left py-2 px-2">Bölge</th>
                            <th class="text-left py-2 px-2 w-20">Tüketim</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in bakilmis_stations %}
                        <tr class="border-b border-base-100 dark:border-base-700 bg-green-50 dark:bg-green-900/20">
                            <td class="py-2 px-2">{{ row.station.benzersiz_kod }} — {{ row.station.ad }}</td>
                            <td class="py-2 px-2">{{ row.station.zone.kod }}</td>
                            <td class="py-2 px-2">{% if row.count_obj.tuketim_var %}Var{% else %}Yok{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
                {% else %}
                <p class="text-base-font-muted-light dark:text-base-font-muted-dark text-sm p-4">Henüz bakılmış istasyon yok.</p>
                {% endif %}
            </div>
        </details>

        <details class="rounded-lg border border-base-200 dark:border-base-700 bg-base-50 dark:bg-base-800 overflow-hidden" {% if bakilmamis_stations and not bakilmis_stations %}open{% endif %}>
            <summary class="px-4 py-3 cursor-pointer font-semibold text-base-font-default-light dark:text-base-font-default-dark hover:bg-base-300 dark:hover:bg-base-700">
                Bakılmamış istasyonlar ({{ bakilmamis_stations|length }})
            </summary>
            <div class="border-t border-base-200 dark:border-base-700">
                {% if bakilmamis_stations %}
                <div class="overflow-auto max-h-48">
                <table class="w-full text-sm border-collapse">
                    <thead>
                        <tr class="border-b border-base-200 dark:border-base-600 bg-base-200 dark:bg-base-700">
                            <th class="text-left py-2 px-2">İstasyon</th>
                            <th class="text-left py-2 px-2">Bölge</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in bakilmamis_stations %}
                        <tr class="border-b border-base-100 dark:border-base-700 text-base-font-muted-light dark:text-base-font-muted-dark">
                            <td class="py-2 px-2">{{ row.station.benzersiz_kod }} — {{ row.station.ad }}</td>
                            <td class="py-2 px-2">{{ row.station.zone.kod }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
                <p class="text-xs text-base-font-muted-light dark:text-base-font-muted-dark p-2 border-t border-base-200 dark:border-base-700">Bu istasyonlar tek tek sayım ile veya toplu liste sayfasından işlenebilir.</p>
                {% else %}
                <p class="text-base-font-muted-light dark:text-base-font-muted-dark text-sm p-4">Tüm istasyonlar bakıldı.</p>
                {% endif %}
            </div>
        </details>
    </div>
    {% else %}
    <p class="text-base-font-muted-light dark:text-base-font-muted-dark text-sm">İş kaydında tesis bilgisi yok. Listeleri görmek için iş kaydında tesis seçin veya toplu liste sayfasını kullanın.</p>
    {% endif %}
</div>

<div id="qr-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 hidden">
    <div class="bg-white dark:bg-base-800 rounded-xl shadow-xl max-w-md w-full p-4 relative">
        <button type="button" id="qr-modal-kapat" class="absolute top-2 right-2 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-base-200 dark:bg-base-600 hover:bg-base-300 dark:hover:bg-base-500 text-2xl font-bold leading-none cursor-pointer" title="Kapat" aria-label="Kapat">×</button>
        <div class="mb-3 pr-8">
            <h3 class="text-lg font-semibold">QR kod okut</h3>
        </div>
        <div id="qr-reader" class="rounded-lg overflow-hidden"></div>
        <p class="text-sm text-base-font-muted-light dark:text-base-font-muted-dark mt-2">QR kodu kameraya tutun. Okutulunca otomatik devam eder.</p>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
(function() {
    var form = document.getElementById('tek-giris-form');
    if (!form) return;
    var benzersizInput = document.getElementById('benzersiz_kod');
    var lookupBtn = document.getElementById('lookup-btn');
    var stationInfo = document.getElementById('station-info');
    var sayimForm = document.getElementById('sayim-save-form');
    var stationIdInput = document.getElementById('station_id');
    var qrModal = document.getElementById('qr-modal');
    var qrOkuBtn = document.getElementById('qr-oku-btn');
    var qrModalKapat = document.getElementById('qr-modal-kapat');
    var qrReaderEl = document.getElementById('qr-reader');
    var qrScanner = null;

    function doLookup() {
        var kod = (benzersizInput && benzersizInput.value) ? benzersizInput.value.trim() : '';
        if (!kod) return;
        var url = '{{ istasyon_sayim_url }}?benzersiz_kod=' + encodeURIComponent(kod);
        fetch(url, { headers: { 'Accept': 'application/json' } })
            .then(function(r) { return r.ok ? r.json() : Promise.reject(r); })
            .then(function(data) {
                if (data.found) {
                    stationInfo.innerHTML = 'İstasyon: <strong>' + (data.ad || data.benzersiz_kod) + '</strong> — ' + data.benzersiz_kod + ' (Tesis: ' + data.facility_kod + ', Bölge: ' + data.zone_kod + ')';
                    stationInfo.classList.remove('hidden');
                    if (stationIdInput) stationIdInput.value = data.id;
                    if (sayimForm) sayimForm.classList.remove('hidden');
                } else {
                    stationInfo.innerHTML = 'İstasyon bulunamadı.';
                    stationInfo.classList.remove('hidden');
                    if (sayimForm) sayimForm.classList.add('hidden');
                }
            })
            .catch(function() {
                stationInfo.innerHTML = 'Arama yapılamadı veya istasyon bulunamadı.';
                stationInfo.classList.remove('hidden');
                if (sayimForm) sayimForm.classList.add('hidden');
            });
    }

    function qrModalGoster() {
        if (!qrModal || !qrReaderEl) return;
        qrModal.classList.remove('hidden');
        qrReaderEl.innerHTML = '';
        if (typeof Html5Qrcode !== 'undefined') {
            qrScanner = new Html5Qrcode('qr-reader');
            qrScanner.start({ facingMode: 'environment' }, { fps: 5, qrbox: { width: 200, height: 200 } }, function(decodedText) {
                if (benzersizInput) benzersizInput.value = decodedText;
                qrScanner.stop().then(function() { if (qrScanner) qrScanner.clear(); qrScanner = null; }).catch(function() {});
                qrModal.classList.add('hidden');
                doLookup();
            }, function() {});
        }
    }

    function qrModalKapatFn() {
        if (qrScanner) {
            qrScanner.stop().then(function() { if (qrScanner) qrScanner.clear(); qrScanner = null; }).catch(function() {});
        }
        if (qrModal) qrModal.classList.add('hidden');
    }

    if (lookupBtn) lookupBtn.addEventListener('click', doLookup);
    if (benzersizInput) benzersizInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); doLookup(); } });
    if (qrOkuBtn) qrOkuBtn.addEventListener('click', qrModalGoster);
    if (qrModalKapat) qrModalKapat.addEventListener('click', qrModalKapatFn);
    if (qrModal) qrModal.addEventListener('click', function(e) { if (e.target === qrModal) qrModalKapatFn(); });
})();
</script>
{% endblock %}
